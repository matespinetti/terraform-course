#!/bin/bash

# User Management Application Deployment Script (Docker Version)

# Update system
sudo dnf update -y

# Install Docker
sudo dnf install -y docker
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -a -G docker ec2-user



# Wait for Docker to be ready
sleep 5

# Verify Docker is running
if ! sudo systemctl is-active --quiet docker; then
    echo "Error: Docker failed to start"
    exit 1
fi

# Pull and run the application container
# Replace 'YOUR_DOCKERHUB_USERNAME' with your actual Docker Hub username
sudo docker run -d \
  --name user-management \
  --restart always \
  --memory=700m \
  --log-driver json-file \
  --log-opt max-size=10m \
  --log-opt max-file=3 \
  -p 8080:8080 \
  -e JAVA_OPTS="-Xmx512m -Xms256m" \
  -e DB_HOSTNAME=${rds_db_endpoint} \
  -e DB_PORT=${rds_db_port} \
  -e DB_NAME=${rds_db_name} \
  -e DB_USERNAME=${rds_db_username} \
  -e DB_PASSWORD=${rds_db_password} \
  matespinetti/user-management:latest

# Check if container started successfully
if [ $? -ne 0 ]; then
    echo "Error: Failed to start container"
    exit 1
fi

# Wait for application to be healthy with timeout
echo "Waiting for application to start..."
for i in {1..30}; do
    if curl -f http://localhost:8080/login >/dev/null 2>&1; then
        echo "Application is healthy!"
        break
    fi
    echo "Attempt $i/30: Application not ready yet, waiting..."
    sleep 10
done

# Check if application started successfully
if ! curl -f http://localhost:8080/login >/dev/null 2>&1; then
    echo "Warning: Application may not be fully ready. Check logs:"
    sudo docker logs user-management
fi

# Log the application URL
echo "========================================"
echo "User Management Application Started!"
echo "Access at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8080"
echo "Default login: admin / admin123"
echo "Container status:"
sudo docker ps --filter name=user-management
echo "========================================"